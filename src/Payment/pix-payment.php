<!DOCTYPE html>
<html lang="en">
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <!-- ‚öôÔ∏è Configura√ß√µes b√°sicas -->
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, viewport-fit=cover">
    <meta name="author" content="Giovani_Sanfer">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#FF0000"> <!-- Cor da marca - vermelho -->
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="bingbot" content="noarchive">
    <meta name="robots" content="noarchive, noimageindex">

    <!-- üß© T√≠tulo e Descri√ß√£o (CR√çTICO para SEO) -->
    <title>Brasm√©rica | Payment </title>
    <meta name="description"
        content="Brasm√©rica Motope√ßas - Loja oficial de pe√ßas e acess√≥rios para motos. Melhores pre√ßos, qualidade garantida e entrega r√°pida. Compre online com seguran√ßa!">
    <meta name="keywords"
        content="Brasm√©rica Motope√ßas, pe√ßas para motos, acess√≥rios moto, motope√ßas online, loja de motope√ßas, capacetes, pneus de moto, escapamentos, freios para moto">

    <!-- üîó Canonical e idioma -->
    <link rel="canonical" href="https://www.brasmerica.com.br/">
    <meta http-equiv="content-language" content="pt-BR">

    <!-- üì± √çcones e Favicons (MELHORADO para todos os dispositivos) -->
    <link
        data-default-icon="https://github.com/machadocalebe/repo-sanfer-imagens/blob/main/brasMerica/imagens/icon-logo2.png?raw=true"
        rel="icon" sizes="192x192"
        href="https://github.com/machadocalebe/repo-sanfer-imagens/blob/main/brasMerica/imagens/icon-logo2.png?raw=true">
    <link rel="icon" type="image/svg+xml"
        href="https://github.com/machadocalebe/repo-sanfer-imagens/blob/main/brasMerica/imagens/icon-logo2.png?raw=true">
    <link rel="icon" type="image/png" sizes="32x32"
        href="https://github.com/machadocalebe/repo-sanfer-imagens/blob/main/brasMerica/imagens/icon-logo2.png?raw=true">
    <link rel="icon" type="image/png" sizes="16x16"
        href="https://github.com/machadocalebe/repo-sanfer-imagens/blob/main/brasMerica/imagens/icon-logo2.png?raw=true">
    <link rel="apple-touch-icon" sizes="180x180"
        href="https://github.com/machadocalebe/repo-sanfer-imagens/blob/main/brasMerica/imagens/icon-logo2.png?raw=true">
    <link rel="apple-touch-icon" sizes="152x152"
        href="https://github.com/machadocalebe/repo-sanfer-imagens/blob/main/brasMerica/imagens/icon-logo2.png?raw=true">
    <link rel="apple-touch-icon" sizes="120x120"
        href="https://github.com/machadocalebe/repo-sanfer-imagens/blob/main/brasMerica/imagens/icon-logo2.png?raw=true">
    <link rel="apple-touch-icon" sizes="76x76"
        href="https://github.com/machadocalebe/repo-sanfer-imagens/blob/main/brasMerica/imagens/icon-logo2.png?raw=true">
    <link rel="mask-icon"
        href="https://github.com/machadocalebe/repo-sanfer-imagens/blob/main/brasMerica/imagens/icon-logo2.png?raw=true"
        color="#FF0000">
    <link href="payment-pix.css?v=2" rel="stylesheet" type="text/css" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="/assets/manifest-BOeWNkvN.json">
    <meta name="application-name" content="Brasm√©rica Motope√ßas">
    <meta name="apple-mobile-web-app-title" content="Brasm√©rica Motope√ßas">

    <!-- üß≠ Open Graph (Facebook / WhatsApp / LinkedIn) -->
    <meta property="og:type" content="website">
    <meta property="og:locale" content="pt_BR">
    <meta property="og:site_name" content="Brasm√©rica Motope√ßas">
    <meta property="og:title" content="Brasm√©rica Motope√ßas - Loja Oficial de Pe√ßas para Motos">
    <meta property="og:description"
        content="Encontre as melhores pe√ßas e acess√≥rios para sua moto na Brasm√©rica Motope√ßas. Qualidade, variedade e os melhores pre√ßos. Compre online!">
    <meta property="og:url" content="https://www.brasmerica.com.br/">
    <meta property="og:image"
        content="https://github.com/machadocalebe/repo-sanfer-imagens/blob/main/brasMerica/imagens/icon-logo2.png?raw=true">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Brasm√©rica Motope√ßas - Loja Oficial">

    <!-- üê¶ Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Brasm√©rica Motope√ßas - Loja Oficial de Pe√ßas para Motos">
    <meta name="twitter:description"
        content="Encontre as melhores pe√ßas e acess√≥rios para sua moto na Brasm√©rica Motope√ßas. Qualidade, variedade e os melhores pre√ßos. Compre online!">
    <meta name="twitter:image"
        content="https://github.com/machadocalebe/repo-sanfer-imagens/blob/main/brasMerica/imagens/icon-logo2.png?raw=true">
    <meta name="twitter:site" content="@brasmerica">
    <meta name="twitter:creator" content="@brasmerica">

    <!-- üîç Verifica√ß√µes e Webmaster Tools -->
    <meta name="google-site-verification" content="SEU_CODIGO_DO_GOOGLE_SEARCH_CONSOLE">
    <meta name="facebook-domain-verification" content="SEU_CODIGO_DO_FACEBOOK">
    <meta name="msvalidate.01" content="SEU_CODIGO_DO_BING">

    <!-- üß† Dados estruturados Schema.org (MELHORADO para neg√≥cio local) -->
    <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "AutoPartsStore",
            "name": "Brasm√©rica Motope√ßas",
            "alternateName": "Brasm√©rica",
            "url": "https://www.brasmerica.com.br",
            "logo": "https://github.com/machadocalebe/repo-sanfer-imagens/blob/main/brasMerica/imagens/icon-logo2.png?raw=true",
            "image": "https://github.com/machadocalebe/repo-sanfer-imagens/blob/main/brasMerica/imagens/icon-logo2.png?raw=true",
            "description": "Brasm√©rica Motope√ßas - Loja oficial de pe√ßas e acess√≥rios para motos. Melhores pre√ßos, qualidade garantida e entrega r√°pida.",
            "address": {
                "@type": "PostalAddress",
                "addressCountry": "BR",
                "addressLocality": "Sua Cidade",
                "addressRegion": "Seu Estado",
                "postalCode": "00000-000",
                "streetAddress": "Sua Rua, N√∫mero"
            },
            "geo": {
                "@type": "GeoCoordinates",
                "latitude": "-23.5505",
                "longitude": "-46.6333"
            },
            "openingHours": "Mo-Fr 08:00-18:00, Sa 08:00-12:00",
            "telephone": "+55-11-99999-9999",
            "email": "contato@brasmerica.com.br",
            "priceRange": "R$",
            "sameAs": [
                "https://www.facebook.com/brasmerica",
                "https://www.instagram.com/brasmerica",
                "https://twitter.com/brasmerica"
            ],
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://www.brasmerica.com.br/search?q={search_term_string}",
                "query-input": "required name=search_term_string"
            }
        }
    </script>

    <!-- üìä Google Tag Manager -->
    <script>
        (function(w, d, s, l, i) {
            w[l] = w[l] || [];
            w[l].push({
                'gtm.start': new Date().getTime(),
                event: 'gtm.js'
            });
            var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s),
                dl = l != 'dataLayer' ? '&l=' + l : '';
            j.async = true;
            j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
            f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'SEU_ID_GTM_AQUI');
    </script>

    <!-- üß∑ Otimiza√ß√µes de Performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://scontent.cdninstagram.com">
    <link rel="dns-prefetch" href="https://scontent.cdninstagram.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">

    <!-- üé® Fonts e Estilos -->
    <link
        href="https://fonts.googleapis.com/css2?family=Archivo+Narrow:ital,wght@0,700;1,600&amp;family=Open+Sans:wght@300;400;600;700&amp;display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
        crossorigin="anonymous" referrerpolicy="no-referrer">
    <script type="module" crossorigin src="/assets/index-BeR3FXKO.js"></script>
    <link rel="stylesheet" crossorigin href="/assets/index-MpFlSgU0.css">
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NBXWDJVT"
            height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <main>
        <section id="first">

            <div style="display: block; background-color: white;" id="responsePayment">
                <?php

                // Caminho para o arquivo .env
                $envPath = __DIR__ . '/../../.env';

                if (file_exists($envPath)) {
                    $lines = file($envPath, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);

                    foreach ($lines as $line) {
                        // Ignora coment√°rios
                        if (str_starts_with(trim($line), '#')) continue;

                        // Divide chave e valor
                        list($name, $value) = explode('=', $line, 2);

                        // Limpa espa√ßos e aspas duplas
                        $name = trim($name);
                        $value = trim($value, " \t\n\r\0\x0B\"'");

                        // Define nas vari√°veis de ambiente
                        putenv("$name=$value");
                        $_ENV[$name] = $value;
                        $_SERVER[$name] = $value;
                    }
                }

                $vindiToken  = getenv('PHP_VINDI_ACESSTOKEN_PAYMENT');

                // Verifica se veio corretamente
                if (!$vindiToken) {
                    echo "<p style='color:orange'>‚ö†Ô∏è Token VINDI n√£o encontrado no .env</p>";
                }

                if ($_SERVER["REQUEST_METHOD"] === "POST") {
                    error_reporting(E_ALL);
                    ini_set('display_errors', 1);

                    $data["finger_print"] = $_POST['finger_print'];
                    $email        = $_POST['email'] ?? '';
                    $name         = $_POST['name'] ?? '';
                    $cpf          = $_POST['cpf'] ?? '';
                    $phone        = $_POST['phone'] ?? '';
                    $postal_code  = $_POST['postal_code'] ?? '';
                    $street       = $_POST['street'] ?? '';
                    $number       = $_POST['number'] ?? '';
                    $neighborhood = $_POST['neighborhood'] ?? '';
                    $city         = $_POST['city'] ?? '';
                    $state        = $_POST['state'] ?? '';
                    $cupom        = $_POST['cupom'];

                    // Processar produtos - verifica m√∫ltiplos produtos
                    $transaction_products = [];
                    $productIndex = 1;
                    $totalAmount = 0; // vari√°vel para acumular o valor total

                    while (true) {
                        $nameKey = 'productsName' . ($productIndex > 1 ? $productIndex : '');
                        $priceKey = 'productsPrice' . ($productIndex > 1 ? $productIndex : '');
                        $quantityKey = 'productsQuantity' . ($productIndex > 1 ? $productIndex : '');

                        // Verifica se existe pelo menos um campo do produto
                        if (isset($_POST[$nameKey]) || isset($_POST[$priceKey]) || isset($_POST[$quantityKey])) {
                            $productName = $_POST[$nameKey] ?? '';
                            $productPrice = (float) ($_POST[$priceKey] ?? 0);
                            $productQuantity = (int) ($_POST[$quantityKey] ?? 0);

                            if (!empty($productName) || !empty($productPrice) || !empty($productQuantity)) {
                                $transaction_products[] = [
                                    "description" => $productName,
                                    "quantity" => $productQuantity,
                                    "price_unit" => $productPrice
                                ];

                                // acumula no total
                                $totalAmount += $productPrice * $productQuantity;

                                $productIndex++;
                                continue;
                            }
                        }
                        break;
                    }


                    $desconto = null;
                    $cupom = strtoupper($cupom);

                    if ($cupom === "NONE") {
                        $desconto = 0;
                    } else {
                        // Aplica 10% de desconto
                        $desconto = ($totalAmount * 10) / 100;

                        // Adiciona produto representando o cupom
                        $transaction_products[] = [
                            "description" => "CUPOM APLICADO NA COMPRA: '$cupom' - 10% DE DESCONTO",
                            "quantity" => 1,
                            "price_unit" => 0
                        ];
                    }

                    // Se n√£o encontrou produtos com numera√ß√£o, tenta o formato antigo (sem n√∫mero)
                    if (empty($transaction_products)) {
                        $productName = $_POST['productsName'] ?? '';
                        $productPrice = (float) ($_POST['productsPrice'] ?? 0);
                        $productQuantity = (int) ($_POST['productsQuantity'] ?? 0);

                        if (!empty($productName) || !empty($productPrice) || !empty($productQuantity)) {
                            $transaction_products[] = [
                                "description" => $productName,
                                "quantity" => $productQuantity,
                                "price_unit" => $productPrice
                            ];

                            // acumula no total
                            $totalAmount += $productPrice * $productQuantity;
                        }
                    }


                    $transactionId = date("YmdHis") . rand(1000, 9999);

                    $payload = [
                        "token_account" => $vindiToken,
                        "customer" => [
                            "email" => $email,
                            "name" => $name,
                            "cpf" => $cpf,
                            "contacts" => [

                                ["type_contact" => "M", "number_contact" => $phone]

                            ],
                            "addresses" => [
                                [
                                    "type_address" => "D",
                                    "postal_code" => $postal_code,
                                    "street" => $street,
                                    "number" => $number,
                                    "completion" => "",
                                    "neighborhood" => $neighborhood,
                                    "city" => $city,
                                    "state" => $state
                                ]
                            ],
                            "business_name" => "Cupom: $cupom"
                        ],
                        "transaction" => [
                            "order_number" => $transactionId,
                            "url_notification" => "https://gateway-postback.fbits.net/api/Yapay",
                            "available_payment_methods" => "3,4,5,6,16,20,25,27",
                            "price_discount" => $desconto,
                            "shipping_type" => "Frete",
                        ],
                        "payment" => [
                            "payment_method_id" => "27"
                        ],
                        "transaction_product" => $transaction_products
                    ];

                    $curl = curl_init();
                    curl_setopt_array($curl, [
                        CURLOPT_URL => 'https://api.intermediador.yapay.com.br/api/v3/transactions/payment',
                        CURLOPT_RETURNTRANSFER => true,
                        CURLOPT_CUSTOMREQUEST => 'POST',
                        CURLOPT_POSTFIELDS => json_encode($payload),
                        CURLOPT_HTTPHEADER => ['Content-Type: application/json'],
                    ]);

                    $response = curl_exec($curl);
                    $httpcode = curl_getinfo($curl, CURLINFO_HTTP_CODE);
                    curl_close($curl);

                    if ($response === false) {
                        echo "<p>Erro na comunica√ß√£o com o gateway.</p>";
                    } else {
                        $responseData = json_decode($response, true);

                        if (
                            $httpcode === 201 &&
                            isset($responseData['data_response']['transaction']['payment'])
                        ) {

                            $paymentData = $responseData['data_response']['transaction']['payment'];
                            $qrcodeImg = $paymentData['qrcode_path'] ?? '';
                            $qrcodeKey = $paymentData['qrcode_original_path'] ?? '';

                            $paymentData2 = $responseData['data_response']['transaction'];
                            $tokenTransaction = $paymentData2['token_transaction'] ?? false;

                            echo "
                                <div style='
                                    background-color: white;
                                    border: 2px solid green;
                                    padding: 20px;
                                    max-width: 400px;
                                    margin: 20px auto;
                                    text-align: center;
                                    border-radius: 8px;
                                    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                                    font-family: Arial, sans-serif;
                                '>
                                    <h3 style='margin-bottom: 20px; background-color: white;'>Escaneie aqui!</h3>
                                    <iframe src='{$qrcodeImg}' style='border:none; width:100%; height:300px; border-radius: 8px;'></iframe>
                                    
                                    <div style='margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 10px;'>
                                        <input type='text' id='pixKey' value='{$qrcodeKey}' readonly 
                                            style='border:1px solid #ccc; padding: 8px; border-radius: 4px; width: 200px; text-align: center; font-weight: bold;'>
                                        <button onclick='copyPix()' style='
                                            background-color: #2e7d32; color: white; border: none; 
                                            padding: 8px 12px; border-radius: 4px; cursor: pointer;
                                            font-weight: bold;
                                        '>Copiar</button>
                                    </div>

                                    <p id='copyMsg' style='color: green; margin-top: 10px; display: none;'>Chave copiada!</p>

                                    <!-- TIMER -->
                                    <p style='margin-top: 15px; font-weight: bold; color: red; background-color: white'>
                                        C√≥digo expira em: <span style='background-color: white' id='timer'>05:00</span>
                                    </p>
                                </div>

                                <script>
                                function copyPix() {
                                    var copyText = document.getElementById('pixKey');
                                    copyText.select();
                                    copyText.setSelectionRange(0, 99999); // Para dispositivos m√≥veis
                                    navigator.clipboard.writeText(copyText.value).then(() => {
                                        var msg = document.getElementById('copyMsg');
                                        msg.style.display = 'block';
                                        setTimeout(() => { msg.style.display = 'none'; }, 2000);
                                    });
                                }

                                // TIMER 10 minutos (600 segundos)
                                let timeLeft = 300;
                                let timerElement = document.getElementById('timer');


                                let countdown = setInterval(() => {
                                    let minutes = String(Math.floor(timeLeft / 60)).padStart(2, '0');
                                    let seconds = String(timeLeft % 60).padStart(2, '0');
                                    timerElement.textContent = minutes + ':' + seconds;

                                    if (timeLeft <= 0) {
                                        clearInterval(countdown);
                                        timerElement.textContent = 'Expirado';
                                        timerElement.style.backgroundColor = 'white';
                                        timerElement.style.color = 'gray';
                                        // Aqui voc√™ pode chamar sua fun√ß√£o de recarregar QR Code
                                        // reloadQRCode();
                                    }

                                    timeLeft--;
                                }, 1000);
                                
                                    const token = '$vindiToken';
                                    const tokenTransaction = '$tokenTransaction';
                                    // Verifica status a cada 3 segundos
                                    const intervalId = setInterval(() => {
                                        fetch('check_status.php?tokenTransaction=' + tokenTransaction + '&token=' + token)
                                            .then(res => res.json())
                                            .then(data => {
                                                if (data.status_id == 6) {
                                                    clearInterval(intervalId); // Para o loop
                                                    // Exemplo: redirecionar ou atualizar elementos
                                                    window.location.href = 'https://www.brasmerica.com.br;
                                                } else {
                                                    console.log('Status atual:', data.status_id);
                                                }
                                            })
                                            .catch(err => console.error('Erro ao checar status:', err));
                                    }, 100);

                                
                                </script>
                                
                            ";
                        } else {
                            echo "<p style='color: red;'>Erro no processamento do pagamento:</p>";
                            echo "<pre>" . print_r($responseData, true) . "</pre>";
                        }
                    }
                }
                ?>
            </div>
            <form id="payment-form" method="post" action="" data-yapay="payment-form">

                <div class="form-group">
                </div>

                <button name="submit" value="Submit" type="submit">Gerar C√≥digo PIX</button>


                <div class="secure">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 0c-.69 0-1.843.265-2.928.56-1.11.3-2.229.655-2.887.87a1.54 1.54 0 0 0-1.044 1.262c-.596 4.477.787 7.795 2.465 9.99a11.777 11.777 0 0 0 2.517 2.453c.386.273.744.482 1.048.625.28.132.581.24.829.24s.548-.108.829-.24a7.159 7.159 0 0 0 1.048-.625 11.775 11.775 0 0 0 2.517-2.453c1.678-2.195 3.061-5.513 2.465-9.99a1.541 1.541 0 0 0-1.044-1.263 62.467 62.467 0 0 0-2.887-.87C9.843.266 8.69 0 8 0zm0 5a1.5 1.5 0 0 1 .5 2.915l.5 1.5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5l.5-1.5A1.5 1.5 0 0 1 8 5z" />
                    </svg>
                    Pagamento seguro com VINDI
                </div>

                <div style="visibility: hidden; display:none">
                    <label hidden>Email:
                        <input type="email" id="email" name="email" hidden required readonly>
                    </label><br><br>

                    <label hidden>Nome:
                        <input type="text" id="name" name="name" hidden required readonly>
                    </label><br><br>

                    <label hidden>CPF:
                        <input type="text" id="cpf" name="cpf" hidden required readonly>
                    </label><br><br>

                    <label hidden>Telefone:
                        <input type="tel" id="phone" name="phone" hidden required readonly>
                    </label><br><br>

                    <label hidden>CEP:
                        <input type="text" id="postal_code" name="postal_code" hidden required readonly>
                    </label><br><br>

                    <label hidden>Rua:
                        <input type="text" id="street" name="street" hidden required readonly>
                    </label><br><br>

                    <label hidden>N√∫mero:
                        <input type="text" id="number" name="number" hidden required readonly>
                    </label><br><br>

                    <label hidden>Bairro:
                        <input type="text" id="neighborhood" name="neighborhood" hidden required readonly>
                    </label><br><br>

                    <label hidden>Cidade:
                        <input type="text" id="city" name="city" hidden required readonly>
                    </label><br><br>

                    <label hidden>Estado:
                        <input type="text" id="state" name="state" hidden required readonly>
                    </label><br><br>

                    <label hidden>Cupom:
                        <input type="text" id="cupom" name="cupom" hidden required readonly>
                    </label><br><br>

                    <div hidden id="products-container">
                        <!-- Os produtos ser√£o inseridos aqui dinamicamente -->
                    </div>
                </div>

            </form>
        </section>

    </main>

    <script src="script.js?v=2"></script>
    <script src="https://static.traycheckout.com.br/js/finger_print.js?v=2" type="text/javascript"></script>
    <script type="text/javascript">
        jQuery(document).FingerPrint().getFingerPrint();
    </script>

</body>

</html>